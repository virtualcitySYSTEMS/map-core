# Vector Cluster Group

Vector clustering is a technique used to group nearby vector features into a single cluster.
This is particularly useful for visualizing large datasets,
as it reduces the number of individual features displayed on the map, making it easier to interpret.

The implementation can only cluster `Point` geometries. This does not include points which act as anchors for
primitives or models or points generated by the geometry function of an ol style. Feature not containing a point geometry
will not be rendered at all.

## Example Configuration

Below is an example configuration where a vector layer is assigned to a vector cluster group:

```json
{
  "vectorClusterGroups": [
    {
      "name": "Cluster Group 1"
    }
  ],
  "layers": [
    {
      "name": "Layer 1",
      "type": "VectorLayer",
      "clusterGroup": "Cluster Group 1"
    }
  ]
}
```

## Template, Styling & Vector Properties

The vector cluster group is style using the `VectorClusterStyleItem`. You can configure the provided icon and text style
using the following options:

```ts
type VectorClusterStyleItemOptions = VcsObjectOptions & {
  template?: string | VectorClusterTemplateFunction;
  fillColor?: string;
  strokeColor?: string;
  strokeWidth?: number;
  textColor?: string;
  font?: string;
  breaks?: number[];
  zeroScaleOffset?: number;
  scaleFactor?: number;
  vectorProperties?: VectorPropertiesOptions;
};
```

And may look something like this:

```json
{
  "name": "Cluster Group 1",
  "clusterDistance": 20,
  "style": {
    "template": "<svg>...</svg>",
    "fillColor": "#ff0000",
    "strokeColor": "#0000ff",
    "strokeWidth": 2,
    "textColor": "#00ff00",
    "font": "12px sans-serif",
    "breaks": [1, 2, 3, 4, 5, 10, 20, 50, 100],
    "zeroScaleOffset": 5,
    "scaleFactor": 1.5
  },
  "vectorProperties": {
    "altitudeMode": "clampToTerrain",
    "heightAboveGround": 10
  }
}
```

### Breaks, ZeroScaleOffset and ScaleFactor

Breaks devide the cluster count into different bins. The first break is the minimum value and the last break is the maximum value.
Using the zeroScaleOffset and scaleFactor you can adjust the size of the cluster. All clusters with a size _below_ the zeroScaleOffset will be rendered without
a prepended + and are considered distinct, for example: `[2, 3, 4, 5, 10]` would render a cluster of 3 as `3` and a cluster of 9 as`5+` and a cluster of 120 as `10+`.

A cluster must consist of more then one feature, there is no break `1`. Features which arent clustered are rendered as single features in the style of
their respective layer.

### Template

You can provide a [vcsTemplate](./vcsTemplate.md) which will be interpreted as an SVG image. The template is passed the following properties by default:

- text: text determined by the style
- fillColor: the css fill color of the style item
- strokeColor: the css stroke color of the style item
- strokeWidth: the stroke widht of the style item
- textColor: the css text color of the style item
- font: the css font of the style item

If you would like to add more or other properties to the cluster template, you can do so by providing a custom template function.
The function is passed the style item itself, the features to in the cluster and a function to retrieve a clustered layer by name (to resolve the layer of a feature).
You must return the template to use and a cache key (so the template is not recompiled on every render). Additionally you can provide a context,
which is an object and its key / values are also passed to the rendering function.

```ts
import { VectorClusterTemplateFunction } from '@vcmap/core';

const tf: VectorClusterTemplateFunction = (styleItem, features, getLayer) => {
  return {
    template: '<svg>...</svg>',
    cacheKey: 'myCacheKey',
    context: {
      myKey: 'myValue',
    },
  };
};
```

### Vector Properties

Vector properties configured on the cluster group itself determine how cluster entities are rendered in 3D. Only vector properties
relevant to _billboards_ are considered, no extrusion is possible. If features are rendered on their own, the properties of the layer are used to the extent where
this is possible (extrusion is still excluded), since in clustering there is a 1:1 relationship from feature
to entity and only the properties applicable to billboards are considered.

The default vector properties slightly differ from those on a vector layer. The differences are:

- `eyeOffset`: [0, 0, -100],
- `heightAboveGround`: 60,
- `altitudeMode`: 'clampToTerrain',

## Picking of Cluster Features

When picking a cluster feature, the cluster is added as the feature to the event. The original features are added as the property
`features` of the event along with the cluster (since the first entry in `features` is always the `feature` property).
You can figure out, if a feature is the cluster itself, by checking for the `vectorClusterGroupName` symbol on the feature.
